<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Angel｜課程設計工作台</title>
  <meta name="theme-color" content="#0f3c2d"/>
  <meta name="description" content="發想→草稿→完稿｜工具庫可同步｜一鍵複製 AI 指令｜TSV 一列輸出｜本機草稿＋JSON備份"/>
  <link rel="manifest" href="./manifest.json"/>
  <link rel="icon" href="./assets/icons/icon-192.png"/>
  <link rel="apple-touch-icon" href="./assets/icons/icon-192.png"/>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>Angel｜課程設計工作台</h1>
        <div class="sub">發想 → 草稿 → 完稿｜工具庫存管理同步｜一鍵複製 AI 指令｜TSV 一列輸出</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn small" id="btnSettings">設定</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="workbench">課程設計工作台</button>
      <button class="tab" data-tab="tools">工具庫存管理</button>
      <button class="tab" data-tab="finals">完稿課程清單</button>
    </div>

    <!-- Workbench -->
    <section class="section active" id="tab-workbench">
      <div class="grid cols2">
        <div class="card solid">
          <h2>狀態進度</h2>
          <div class="mini">你可以先把骨架站穩，再慢慢補完整。任何時候停下來都可以。</div>
          <div style="height:10px"></div>
          <div class="pills" id="statusPills"></div>
          <div style="height:12px"></div>

          <div class="row">
            <div class="field" style="flex:1; min-width:200px;">
              <label>目前狀態</label>
              <select id="stateSelect">
                <option value="idea">發想</option>
                <option value="draft">草稿</option>
                <option value="final">完稿</option>
              </select>
            </div>
            <div class="field" style="flex:1; min-width:200px;">
              <label>課程形式</label>
              <select id="kindSelect">
                <option value="lecture">演講</option>
                <option value="module">模組課程</option>
                <option value="single_class">單場課程</option>
                <option value="single_event">單場活動</option>
                <option value="other">其他（手動輸入）</option>
              </select>
            </div>
            <div class="field" id="kindOtherWrap" style="flex:1; min-width:200px; display:none;">
              <label>其他形式名稱</label>
              <input id="kindOther" placeholder="例如：工作坊 / 企業內訓 / 親子體驗..."/>
            </div>
          </div>

          <div class="row" id="scheduleRow">
            <div class="field" style="flex:1; min-width:200px;">
              <label id="episodesLabel">模組堂數（episodes）</label>
              <input id="episodes" type="number" min="1" value="8"/>
            </div>
            <div class="field" style="flex:1; min-width:200px;">
              <label id="durationLabel">每堂時間（分鐘）</label>
              <input id="durationMin" type="number" min="10" value="120"/>
            </div>
            <div class="field" style="flex:1; min-width:200px;">
              <label>人數（capacity）</label>
              <input id="capacity" type="number" min="1" value="20"/>
            </div>
          </div>

          <hr class="sep"/>

          <div class="row">
            <div class="field" style="flex:1; min-width:240px;">
              <label>課名（title）</label>
              <input id="title" placeholder="例如：給親子的｜幸福教養體驗活動"/>
            </div>
            <div class="field" style="flex:1; min-width:180px;">
              <label>對象（audience）</label>
              <input id="audience" placeholder="例如：親子 / 家長 / 老師 / 成人關係..."/>
            </div>
          </div>

          <div class="row">
            <div class="field" style="flex:1; min-width:240px;">
              <label>標籤 tags（用空格或 # 分隔）</label>
              <input id="tags" placeholder="#教養焦慮 #情緒急救 #關係修復"/>
            </div>
            <div class="field" style="flex:1; min-width:240px;">
              <label>擁有者 owner（可留空）</label>
              <input id="owner" placeholder="例如：天使笑長"/>
            </div>
          </div>

          <div class="field">
            <label>I-2｜結果感 closing_line（結尾一句話）</label>
            <textarea id="closingLine" placeholder="例如：孩子不需要你完美，他需要你回得來。"></textarea>
          </div>

          <hr class="sep"/>

          <div class="row">
            <div class="field" style="flex:1; min-width:260px;">
              <label>主工具（單選）</label>
              <div class="row">
                <input id="mainTool" placeholder="尚未選擇" readonly/>
                <button class="btn small" id="btnPickMain">選主工具</button>
              </div>
            </div>
            <div class="field" style="flex:1; min-width:260px;">
              <label>副工具（多選）</label>
              <div class="row">
                <input id="subTools" placeholder="尚未選擇" readonly/>
                <button class="btn small" id="btnPickSubs">選副工具</button>
              </div>
            </div>
          </div>

          <div class="field">
            <label>核心流程架構（framework_text）</label>
            <textarea id="frameworkText" placeholder="用你最順口的一段話，先把流程站穩。"></textarea>
          </div>

          <div class="field" id="outlineWrap">
            <label id="outlineLabel">I-4｜大綱（依堂數自動產生欄位）</label>
            <div id="outlineList"></div>
          </div>

          <div class="field" id="draftExtra" style="display:none;">
            <hr class="sep"/>
            <h2 style="margin-top:0;">草稿/完稿補充（可試教 / 可上架）</h2>
            <div class="mini">草稿與完稿都能一鍵產生「完整課堂企劃＋教材與作業內容」的 AI 協作指令。</div>

            <div class="field">
              <label>objectives（條列）</label>
              <textarea id="objectives" placeholder="例如：
- 大人先穩定：把心站穩
- 孩子情緒降溫：回到感官
- 關係修復：把話說得出口"></textarea>
            </div>
            <div class="field">
              <label>summary（對外版簡介）</label>
              <textarea id="summary" placeholder="對外可讀的一段話（草稿可先短版，完稿再定稿）。"></textarea>
            </div>
            <div class="field">
              <label>materials（教材/材料清單）</label>
              <textarea id="materials" placeholder="例如：PPT、練習單、提醒卡、結業小抄..."></textarea>
            </div>
            <div class="field">
              <label>notes（備註）</label>
              <textarea id="notes" placeholder="例如：試教觀察、修正方向、版本紀錄..."></textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>快速操作</h2>
          <div class="mini">先把需要的按鈕放在手邊：複製、備份、同步。</div>

          <div style="height:10px"></div>
          <div class="progress">
            <span class="badge">Wizard</span>
            <div class="stepdot active" id="dot1">1</div>
            <div class="stepdot" id="dot2">2</div>
            <div class="stepdot" id="dot3">3</div>
            <div class="stepdot" id="dot4">4</div>
          </div>

          <hr class="sep"/>

          <div class="field">
            <label>狀態資料</label>
            <div class="mini" id="stateHint"></div>
          </div>

          <div class="field">
            <label>後臺同步（可選）</label>
            <div class="mini">若你已完成課程管理 API（含 發想/草稿/幸福教養課程管理 三分頁），可直接按同步。</div>
            <div class="row">
              <button class="btn primary" id="btnSync">同步到後臺（本狀態）</button>
              <button class="btn" id="btnLoadFromApi">從後臺抓（本狀態清單）</button>
            </div>
            <div class="mini monos" id="syncLog" style="margin-top:8px;"></div>
          </div>

          <hr class="sep"/>

          <div class="field">
            <label>本機草稿（localStorage）</label>
            <div class="row">
              <button class="btn" id="btnSaveLocal">存本機草稿</button>
              <button class="btn" id="btnLoadLocal">叫出本機草稿</button>
              <button class="btn" id="btnClearLocal">清空本機草稿</button>
            </div>
          </div>

          <div class="field">
            <label>備份</label>
            <div class="row">
              <button class="btn" id="btnExportJson">匯出 JSON（備份）</button>
              <label class="mini" style="display:flex; gap:8px; align-items:center; margin:0;">
                <input type="checkbox" id="autoCleanNewlines" checked/>
                自動清理換行（複製用）
              </label>
            </div>
          </div>

          <hr class="sep"/>

          <div class="field">
            <label>複製輸出</label>
            <div class="row">
              <button class="btn primary" id="btnCopyAI">一鍵複製｜AI 指令</button>
              <button class="btn" id="btnCopyTSV">一鍵複製｜TSV 一列（本狀態）</button>
            </div>
          </div>

          <div class="field">
            <label>提示</label>
            <div class="mini">你現在做得很好。先把「可以開始」放在第一位，完整可以慢慢長出來。</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tools -->
    <section class="section" id="tab-tools">
      <div class="card solid">
        <h2>工具庫存管理（同步＋快取）</h2>
        <div class="mini">這裡顯示「工具庫存管理 API」回來的工具。若網路不穩，也會用本機快取讓你能勾選。</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnToolsSync">同步工具庫</button>
          <button class="btn" id="btnToolsClearCache">清空工具快取</button>
        </div>
        <div class="field">
          <label>搜尋</label>
          <input id="toolsSearch" placeholder="輸入：MIX / EQ / COM / ACT / REL / KIDS / 工具名稱 / 痛點關鍵字"/>
        </div>
        <div class="row">
          <div class="field" style="flex:1; min-width:200px;">
            <label>Prefix 篩選</label>
            <select id="toolsPrefix">
              <option value="">全部</option>
              <option value="MIX">MIX</option>
              <option value="EQ">EQ</option>
              <option value="COM">COM</option>
              <option value="ACT">ACT</option>
              <option value="REL">REL</option>
              <option value="KIDS">KIDS</option>
            </select>
          </div>
          <div class="field" style="flex:1; min-width:260px;">
            <label>Category 篩選</label>
            <input id="toolsCategory" placeholder="例如：綜合/基礎定頻工具"/>
          </div>
        </div>
        <div id="toolsList" class="tool-list"></div>
      </div>
    </section>

    <!-- Finals -->
    <section class="section" id="tab-finals">
      <div class="card solid">
        <h2>完稿課程清單（從後臺抓）</h2>
        <div class="mini">完稿只收可上架成品。你可以從這裡叫出，再一鍵複製 AI 指令或 TSV。</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnFinalsLoad">抓完稿清單</button>
        </div>
        <div class="field">
          <label>搜尋</label>
          <input id="finalsSearch" placeholder="輸入課名/標籤/對象"/>
        </div>
        <div id="finalsList" class="tool-list"></div>
      </div>
    </section>
  </div>

  <!-- Footer buttons (always visible) -->
  <div class="footerbar">
    <div class="footerinner">
      <button class="btn primary" id="fCopyAI">一鍵複製｜AI 指令</button>
      <button class="btn" id="fCopyTSV">一鍵複製｜TSV 一列</button>
      <button class="btn" id="fSaveLocal">存本機草稿</button>
      <button class="btn" id="fExportJson">匯出 JSON</button>
    </div>
  </div>

  <!-- Tool Picker Modal -->
  <div class="modal-backdrop" id="modalBg"></div>
  <div class="modal" id="toolModal">
    <header>
      <h3 id="modalTitle">選工具</h3>
      <div class="actions">
        <button class="btn small" id="modalClose">關閉</button>
      </div>
    </header>
    <div class="tool-list">
      <div class="field">
        <label>搜尋工具</label>
        <input id="modalSearch" placeholder="輸入工具ID/名稱/痛點/分類"/>
      </div>
      <div class="row">
        <div class="field" style="flex:1; min-width:200px;">
          <label>Prefix</label>
          <select id="modalPrefix">
            <option value="">全部</option>
            <option value="MIX">MIX</option>
            <option value="EQ">EQ</option>
            <option value="COM">COM</option>
            <option value="ACT">ACT</option>
            <option value="REL">REL</option>
            <option value="KIDS">KIDS</option>
          </select>
        </div>
        <div class="field" style="flex:1; min-width:260px;">
          <label>Category</label>
          <input id="modalCategory" placeholder="可留空"/>
        </div>
      </div>
      <div id="modalTools"></div>
      <div style="height:8px"></div>
      <div class="row" id="modalFooterActions">
        <button class="btn primary" id="modalConfirm">確認選擇</button>
      </div>
      <div class="mini">若工具沒出現，請先到「工具庫存管理」按「同步工具庫」。</div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <header>
      <h3>設定</h3>
      <div class="actions">
        <button class="btn small" id="settingsClose">關閉</button>
      </div>
    </header>
    <div class="tool-list">
      <div class="mini">把 API 放好，就能同步工具庫與課程三狀態（發想/草稿/幸福教養課程管理）。</div>

      <div class="field">
        <label>工具庫存管理 API（Tools）</label>
        <input id="toolsApi" placeholder="貼上你的 Tools API Web app URL"/>
      </div>

      <div class="field">
        <label>幸福教養課程管理 API（Course Manager）</label>
        <input id="courseApi" placeholder="貼上你的 Course API Web app URL"/>
      </div>

      <div class="row">
        <button class="btn primary" id="settingsSave">儲存設定</button>
        <button class="btn" id="settingsPing">測試 ping</button>
      </div>

      <hr class="sep"/>
      <div class="mini monos" id="settingsLog"></div>
      <div class="mini">提醒：GAS Web app 建議「執行身分：我」＋「誰可存取：任何人」。</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="./app.js"></script>
</body>
</html>